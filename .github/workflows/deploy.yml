name: Publish and Flush

on:
  push:
    branches:
      - default

jobs:
  deploy:
    # if: contains(toJson(github.event.commits), '[deploy site]') == true
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ' 0.136.5'
          extended: true
      - name: Build
        run: chmod +x build-site.sh && ./build-site.sh
        env:
          OUR_CI_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ${{secrets.OUR_CI_TOKEN}}
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.OUR_CI_TOKEN }}
          publish_dir: ./website_and_docs/public
          publish_branch: publish
          user_name: 'The CI Bot'
          user_email: 'mysrcs-ci@users.noreply.github.com'
          commit_message: ${{ github.event.head_commit.message }}
          # cname: www.example.com

      - name: Delete Build Artifact
        uses: joutvhu/delete-artifact@v2.0.1
        # with:
          # owner: mysrcs # optional Default is current owner.
          # repo: mysrcs.github.io # optional Default is current repository.
          # run-id: build # optional If github-token is specified, this is the run that artifacts will be deleted from.
          # token: # optional If this is not specified, the action will attempt to delete artifacts from the current repository and the current workflow run.
          # latest: # optional In the case of reruns, this can be useful to avoid duplicates
          # name: github-pages # optional The artifact to delete, multiple names can be supplied on new lines.
          # pattern: # optional A glob pattern matching the artifacts that should be deleted. Ignored if name is specified.

  # Delete workflows
  del_runs:
    runs-on: ubuntu-latest
    needs: deploy
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete workflow runs
        uses: Rubber1Duck/delete-old-workflow-runs@v0.4.0
        with:
          repository: mysrcs/hugooooo   # replace this with your own repository
          older-than-seconds: 100             # remove all workflow runs older than 1 day ( default 86400 )
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
